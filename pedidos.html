<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>üìã Agendamentos Realizados</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root {
      --primary:   #0066cc;
      --secondary: #f0f0f0;
      --bg:        #f4f4f4;
      --text:      #333;
      --confirm:   #27ae60;
      --cancel:    #c0392b;
      --pending:   #e67e22;
    }
    * { box-sizing: border-box; margin:0; padding:0; }
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: var(--bg); color: var(--text);
      padding: 20px;
    }
    .container {
      max-width: 1200px; margin: auto;
      background: #fff; padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    h2 { text-align: center; margin-bottom: 10px; font-size: 1.8rem; color: var(--primary); }
    #statusCounts {
      text-align: center;
      margin-bottom: 16px;
      font-weight: bold;
    }
    .filter-container { text-align: center; margin: 20px 0; }
    .filter-container input {
      width: 200px; max-width: 45%;
      padding: 8px 12px; margin: 0 5px;
      font-size: 1rem; border: 1px solid #ccc;
      border-radius: 6px;
    }
    table {
      width: 100%; border-collapse: collapse;
      margin-bottom: 20px;
    }
    th, td {
      padding: 12px 15px; border: 1px solid #e0e0e0;
      text-align: center; font-size: 0.9rem;
    }
    th {
      background: var(--secondary);
      text-transform: uppercase;
      font-weight: 600;
    }
    tr:nth-child(even) { background: #fafafa; }
    tr:hover { background: #f1f1f1; }
    .status-cell { font-weight: bold; }
    .status-pendente   { color: var(--pending); }
    .status-confirmado { color: var(--confirm); }
    .status-cancelado  { color: var(--cancel); }
    .action-btn {
      padding: 6px 10px; font-size: 0.8rem;
      border: none; border-radius: 4px;
      color: #fff; cursor: pointer;
      transition: background 0.2s; margin: 0 2px;
    }
    .confirm-btn       { background: var(--confirm); }
    .confirm-btn:hover { background: #219150; }
    .cancel-btn-action { background: var(--cancel); }
    .cancel-btn-action:hover { background: #992d22; }
    .edit-btn          { background: #f39c12; }
    .edit-btn:hover    { background: #d78f0f; }
    .delete-btn        { background: #dc3545; }
    .delete-btn:hover  { background: #c82333; }
    .btn-voltar {
      padding: 8px 12px; background: var(--primary);
      color: #fff; border: none; border-radius: 6px;
      cursor: pointer; font-size: 0.9rem;
    }
    .btn-voltar:hover { background: #0052a3; }
    /* Modal de Edi√ß√£o */
    #modalEdit {
      display: none; position: fixed;
      top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.6);
      align-items: center; justify-content: center;
      padding: 10px;
    }
    .modal-content {
      background: #fff; padding: 20px; border-radius: 8px;
      max-width: 400px; width: 100%;
    }
    .modal-content h3 {
      margin-bottom: 12px; color: var(--primary);
    }
    .modal-content label {
      display: block; margin-top: 8px; font-weight: 600;
    }
    .modal-content input,
    .modal-content select {
      width: 100%; padding: 8px; margin-top: 4px;
      border: 1px solid #ccc; border-radius: 4px;
    }
    .modal-actions {
      margin-top: 16px;
      display: flex; justify-content: flex-end; gap: 8px;
    }
    .modal-actions button {
      padding: 8px 12px; border: none;
      border-radius: 4px; cursor: pointer;
    }
    .save-btn { background: var(--confirm); color: #fff; }
    .save-btn:hover { background: #219150; }
    .cancel-btn { background: #bdc3c7; color: #2c3e50; }
    .cancel-btn:hover { background: #a4acb0; }
    @media (max-width: 768px) {
      table, thead, tbody, th, td, tr { display: block; }
      thead tr { display: none; }
      tr { margin-bottom: 15px; }
      td {
        display: flex; justify-content: space-between;
        padding: 8px;
      }
      td::before {
        content: attr(data-label);
        font-weight: 600; flex:1 0 50%;
      }
      .filter-container input { width: 100%; margin: 5px 0; }
      .modal-content { padding: 15px; }
      .modal-actions { flex-direction: column; }
      .modal-actions button { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üìã Agendamentos Realizados</h2>

    <!-- Contador de status -->
    <div id="statusCounts">Carregando contagens...</div>

    <div class="filter-container">
      <input type="text" id="filterTipo" placeholder="üîç Filtrar por exame‚Ä¶">
      <input type="date" id="filterData">
    </div>

    <table>
      <thead>
        <tr>
          <th>Nome</th>
          <th>CPF</th>
          <th>Telefone</th>
          <th>E-mail</th>
          <th>Exame</th>
          <th>Data/Hora Exame</th>
          <th>Local</th>
          <th>Criado em</th>
          <th>Status</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="listaAgendamentos">
        <tr><td colspan="10" style="padding:20px">Carregando agendamentos...</td></tr>
      </tbody>
    </table>

   
  </div>

  <!-- Modal de Edi√ß√£o -->
  <div id="modalEdit">
    <div class="modal-content">
      <h3>‚úèÔ∏è Editar Agendamento</h3>
      <label>Nome</label><input type="text" id="editNome">
      <label>CPF</label><input type="text" id="editCpf">
      <label>Telefone</label><input type="text" id="editTelefone">
      <label>E-mail</label><input type="email" id="editEmail">
      <label>Tipo de Exame</label>
      <select id="editTipo">
        <option>Hemograma</option>
        <option>Urina</option>
        <option>Raio-X</option>
        <option>Ultrassonografia</option>
        <option>Tomografia</option>
        <option>Resson√¢ncia</option>
        <option>ECG</option>
        <option>Glicemia de Jejum</option>
        <option>Outros</option>
      </select>
      <label>Data do Exame</label><input type="date" id="editDataExame">
      <label>Hora do Exame</label><input type="time" id="editHoraExame">
      <label>Local do Exame</label><input type="text" id="editLocalExame" placeholder="Digite o local">
      <label>Data de Cria√ß√£o</label><input type="datetime-local" id="editDataCriacao">
      <div class="modal-actions">
        <button class="save-btn" onclick="salvarEdicao()">Salvar</button>
        <button class="cancel-btn" onclick="fecharModal()">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    // --- Configura√ß√£o Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyDIfTE3Nkwb_yiDKJhmwj_o3I8guislO8g",
      authDomain: "clinica-3f715.firebaseapp.com",
      databaseURL: "https://clinica-3f715-default-rtdb.firebaseio.com",
      projectId: "clinica-3f715",
      storageBucket: "clinica-3f715.firebasestorage.app",
      messagingSenderId: "456473690332",
      appId: "1:456473690332:web:667b239d83c802ecb83419",
      measurementId: "G-7XHX0XC3BD"
    };
    firebase.initializeApp(firebaseConfig);

    const refAgend      = firebase.database().ref("agendamentos");
    const filtroTipo    = document.getElementById("filterTipo");
    const filtroData    = document.getElementById("filterData");
    const tbody         = document.getElementById("listaAgendamentos");
    const statusCounts  = document.getElementById("statusCounts");
    let agendamentos    = [];
    let chaveAtual      = null;

    function parseBR(dtStr) {
      if (!dtStr) return new Date(0);
      const [d,t] = dtStr.split(", "),
            [dia,mes,ano] = d.split("/").map(Number),
            [hh,mm]       = t.split(":").map(Number);
      return new Date(ano, mes-1, dia, hh, mm);
    }
    function toLocalISO(dt) {
      const pad = n => String(n).padStart(2,'0');
      return `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}T${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
    }
    function formatBR(dt) {
      const pad = n => String(n).padStart(2,'0');
      return `${pad(dt.getDate())}/${pad(dt.getMonth()+1)}/${dt.getFullYear()}, ${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
    }

    function updateCounts() {
      let pend = 0, conf = 0, canc = 0;
      agendamentos.forEach(a => {
        if (a.status === 'Confirmado') conf++;
        else if (a.status === 'Cancelado') canc++;
        else pend++;
      });
      statusCounts.textContent =
        `Pendentes: ${pend} | Confirmados: ${conf} | Cancelados: ${canc}`;
    }

    function render() {
      const tp = filtroTipo.value.trim().toLowerCase(),
            fd = filtroData.value;
      tbody.innerHTML = "";

      const filt = agendamentos.filter(a => {
        const okTipo = !tp || a.tipo.toLowerCase().includes(tp);
        const okData = !fd || a.dataExame === fd;
        return okTipo && okData;
      });

      if (!filt.length) {
        tbody.innerHTML = `<tr><td colspan="10">Nenhum agendamento encontrado.</td></tr>`;
      } else {
        filt.sort((a,b) => parseBR(b.criadoEmFormatado) - parseBR(a.criadoEmFormatado))
          .forEach(a => {
            const statusClass = a.status==='Confirmado'
              ? 'status-confirmado'
              : a.status==='Cancelado'
                ? 'status-cancelado'
                : 'status-pendente';

            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td data-label="Nome">${a.nome}</td>
              <td data-label="CPF">${a.cpf}</td>
              <td data-label="Telefone">${a.telefone}</td>
              <td data-label="E-mail">${a.email}</td>
              <td data-label="Exame">${a.tipo}</td>
              <td data-label="Data/Hora Exame">${a.dataExame} ${a.horaExame}</td>
              <td data-label="Local">${a.localExame}</td>
              <td data-label="Criado em">${a.criadoEmFormatado}</td>
              <td data-label="Status" class="status-cell ${statusClass}">${a.status||'Pendente'}</td>
              <td data-label="A√ß√µes">
                <button class="action-btn confirm-btn"     onclick="confirmar('${a.key}')">‚úîÔ∏è</button>
                <button class="action-btn cancel-btn-action" onclick="cancelar('${a.key}')">‚ùå</button>
                <button class="action-btn edit-btn"        onclick="abrirModal('${a.key}')">‚úèÔ∏è</button>
                <button class="action-btn delete-btn"      onclick="excluirAgendamento('${a.key}')">üóëÔ∏è</button>
              </td>`;
            tbody.appendChild(tr);
          });
      }

      updateCounts();
    }

    refAgend.on("value", snap => {
      agendamentos = [];
      snap.forEach(child => {
        const v = child.val();
        agendamentos.push({
          key:               child.key,
          nome:              v.nome,
          cpf:               v.cpf,
          telefone:          v.telefone,
          email:             v.email,
          tipo:              v.tipo,
          dataExame:         v.dataExame || "",
          horaExame:         v.horaExame || "",
          localExame:        v.localExame || "",
          criadoEmFormatado: v.criadoEmFormatado || "",
          status:            v.status || "Pendente"
        });
      });
      render();
    });

    filtroTipo.addEventListener("input", render);
    filtroData.addEventListener("change", render);

    function confirmar(key) {
      refAgend.child(key).update({ status: 'Confirmado' })
        .then(() => {
          const ag = agendamentos.find(a => a.key === key);
          const mensagem =
            `‚úÖ *Confirma√ß√£o de Exame*\n\n` +
            `Ol√°, *${ag.nome}*!\n` +
            `Seu exame *${ag.tipo}* foi *confirmado*.\n` +
            `üìÖ Data/Hora: ${ag.dataExame} ${ag.horaExame}\n` +
            `üìç Local: ${ag.localExame}\n\n` +
            `At√© breve!`;
          const tel = ag.telefone.replace(/\D/g, '');
          window.open(
            `https://api.whatsapp.com/send?phone=55${tel}&text=` +
            encodeURIComponent(mensagem),
            "_blank"
          );
        });
    }
    function cancelar(key) {
      refAgend.child(key).update({ status: 'Cancelado' });
    }
    function excluirAgendamento(key) {
      if (confirm("Deseja realmente excluir este agendamento?")) {
        refAgend.child(key).remove();
      }
    }

    function abrirModal(key) {
      chaveAtual = key;
      const ag = agendamentos.find(a => a.key === key);
      document.getElementById("editNome").value      = ag.nome;
      document.getElementById("editCpf").value       = ag.cpf;
      document.getElementById("editTelefone").value  = ag.telefone;
      document.getElementById("editEmail").value     = ag.email;
      document.getElementById("editTipo").value      = ag.tipo;
      document.getElementById("editDataExame").value = ag.dataExame;
      document.getElementById("editHoraExame").value = ag.horaExame;
      document.getElementById("editLocalExame").value= ag.localExame;
      document.getElementById("editDataCriacao").value = toLocalISO(parseBR(ag.criadoEmFormatado));
      document.getElementById("modalEdit").style.display = "flex";
    }
    function fecharModal() {
      document.getElementById("modalEdit").style.display = "none";
      chaveAtual = null;
    }
    function salvarEdicao() {
      if (!chaveAtual) return;
      const dtCri = new Date(document.getElementById("editDataCriacao").value);
      const up = {
        nome:       document.getElementById("editNome").value.trim(),
        cpf:        document.getElementById("editCpf").value.trim(),
        telefone:   document.getElementById("editTelefone").value.trim(),
        email:      document.getElementById("editEmail").value.trim(),
        tipo:       document.getElementById("editTipo").value,
        dataExame:  document.getElementById("editDataExame").value,
        horaExame:  document.getElementById("editHoraExame").value,
        localExame: document.getElementById("editLocalExame").value.trim(),
        criadoEmTimestamp: dtCri.getTime(),
        criadoEmFormatado: formatBR(dtCri)
      };
      refAgend.child(chaveAtual).update(up).then(fecharModal);
    }

    firebase.auth().onAuthStateChanged(u => {
      if (!u) window.location.href = "login.html";
    });
    function voltar() {
      window.location.href = "index.html";
    }
  </script>
</body>
</html>
