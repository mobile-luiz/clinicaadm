<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>üìã Agendamentos Realizados</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root {
      --primary:   #0066cc;
      --secondary: #f0f0f0;
      --bg:        #f4f4f4;
      --text:      #333;
      --confirm:   #27ae60;
      --cancel:    #c0392b;
      --pending:   #e67e22;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      font-size: 1.8rem;
      color: var(--primary);
      margin-bottom: 10px;
    }
    #statusCounts {
      text-align: center;
      margin-bottom: 16px;
      font-weight: bold;
    }
    .filter-container {
      text-align: center;
      margin: 20px 0;
    }
    .filter-container input {
      width: 200px;
      max-width: 45%;
      padding: 8px 12px;
      margin: 0 5px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
    }
    .table-wrapper {
      overflow-x: auto;
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
    }
    th, td {
      padding: 12px 15px;
      border: 1px solid #e0e0e0;
      text-align: center;
      font-size: 0.9rem;
    }
    th {
      background: var(--secondary);
      text-transform: uppercase;
      font-weight: 600;
    }
    tr:nth-child(even) { background: #fafafa; }
    tr:hover          { background: #f1f1f1; }
    .status-cell      { font-weight: bold; }
    .status-pendente  { color: var(--pending); }
    .status-confirmado{ color: var(--confirm); }
    .status-cancelado { color: var(--cancel); }

    .action-btn {
      padding: 6px 10px;
      font-size: 0.8rem;
      border: none;
      border-radius: 4px;
      color: #fff;
      cursor: pointer;
      transition: background 0.2s;
      margin: 2px;
    }
    .confirm-btn       { background: var(--confirm); }
    .confirm-btn:hover { background: #219150; }
    .cancel-btn-action { background: var(--cancel); }
    .cancel-btn-action:hover { background: #992d22; }
    .edit-btn          { background: #f39c12; }
    .edit-btn:hover    { background: #d78f0f; }
    .delete-btn        { background: #dc3545; }
    .delete-btn:hover  { background: #c82333; }

    /* Modal */
    #modalEdit {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      align-items: center;
      justify-content: center;
      padding: 10px;
    }
    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      max-width: 400px;
      width: 100%;
    }
    .modal-content h3     { margin-bottom: 12px; color: var(--primary); }
    .modal-content label  { display: block; margin-top: 8px; font-weight: 600; }
    .modal-content input,
    .modal-content select {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .modal-actions {
      margin-top: 16px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }
    .modal-actions button {
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .save-btn   { background: var(--confirm); color: #fff; }
    .save-btn:hover { background: #219150; }
    .cancel-btn { background: #bdc3c7; color: #2c3e50; }
    .cancel-btn:hover { background: #a4acb0; }

    @media (max-width: 768px) {
      .filter-container input { width: 100%; margin: 5px 0; }

      table, thead, tbody, th, td, tr { display: block; }
      thead tr { position: absolute; top: -9999px; left: -9999px; }
      tr {
        margin-bottom: 15px;
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 10px;
      }
      td {
        position: relative;
        padding-left: 50%;
        text-align: left;
      }
      td::before {
        position: absolute;
        top: 12px; left: 15px;
        width: 45%;
        white-space: nowrap;
        content: attr(data-label)":";
        font-weight: 600;
      }

      .modal-actions { flex-direction: column; }
      .modal-actions button { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üìã Agendamentos Realizados</h2>
    <div id="statusCounts">Carregando contagens...</div>
    <div class="filter-container">
      <input id="filterTipo" type="text" placeholder="üîç Filtrar por exame‚Ä¶">
      <input id="filterData" type="date">
    </div>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Cl√≠nica</th>
            <th>Nome</th>
            <th>CPF</th>
            <th>Telefone</th>
            <th>E-mail</th>
            <th>Exame</th>
            <th>Data/Hora Exame</th>
            <th>Local</th>
            <th>Status</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="listaAgendamentos">
          <tr><td colspan="10" style="padding:20px">Carregando agendamentos...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div id="modalEdit">
    <div class="modal-content">
      <h3>‚úèÔ∏è Editar Agendamento</h3>
      <label>Cl√≠nica</label><input id="editClinica" type="text" placeholder="Digite o nome da cl√≠nica">
      <label>Nome</label><input id="editNome" type="text">
      <label>CPF</label><input id="editCpf" type="text">
      <label>Telefone</label><input id="editTelefone" type="text">
      <label>E-mail</label><input id="editEmail" type="email">
      <label>Tipo de Exame</label>
      <select id="editTipo">
        <option>Hemograma Completo</option>
        <option>Urina Tipo I</option>
        <option>Raio-X Simples</option>
        <option>Ultrassonografia</option>
        <option>Tomografia Computadorizada</option>
        <option>Resson√¢ncia Magn√©tica</option>
        <option>Eletrocardiograma (ECG)</option>
        <option>Ecocardiograma</option>
        <option>Endoscopia Digestiva</option>
        <option>Colonoscopia</option>
        <option>Mamografia</option>
        <option>Densitometria √ìssea</option>
        <option>Bi√≥psia</option>
        <option>Glicemia de Jejum</option>
        <option>Teste de Esfor√ßo</option>
        <option>Perfil Lip√≠dico</option>
        <option>Outros</option>
      </select>
      <label>Data do Exame</label><input id="editDataExame" type="date">
      <label>Hora do Exame</label><input id="editHoraExame" type="time">
      <label>Local do Exame</label><input id="editLocalExame" type="text" placeholder="Digite o local">
      <label>Data de Cria√ß√£o</label><input id="editDataCriacao" type="datetime-local">
      <div class="modal-actions">
        <button class="save-btn" onclick="salvarEdicao()">Salvar</button>
        <button class="cancel-btn" onclick="fecharModal()">Cancelar</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDIfTE3Nkwb_yiDKJhmwj_o3I8guislO8g",
      authDomain: "clinica-3f715.firebaseapp.com",
      databaseURL: "https://clinica-3f715-default-rtdb.firebaseio.com",
      projectId: "clinica-3f715",
      storageBucket: "clinica-3f715.firebasestorage.app",
      messagingSenderId: "456473690332",
      appId: "1:456473690332:web:667b239d83c802ecb83419",
      measurementId: "G-7XHX0XC3BD"
    };
    firebase.initializeApp(firebaseConfig);

    const refAgend     = firebase.database().ref('agendamentos');
    const filtroTipo   = document.getElementById('filterTipo');
    const filtroData   = document.getElementById('filterData');
    const tbody        = document.getElementById('listaAgendamentos');
    const statusCounts = document.getElementById('statusCounts');
    const editClinica  = document.getElementById('editClinica');
    const editDataInp  = document.getElementById('editDataExame');
    let agendamentos = [], chaveAtual = null;

    // Bloqueia datas anteriores a hoje
    editDataInp.min = new Date().toISOString().split('T')[0];

    function parseBR(str) {
      if (!str) return new Date(0);
      const [d,t] = str.split(', '),
            [dia,mes,ano] = d.split('/').map(Number),
            [hh,mm] = t.split(':').map(Number);
      return new Date(ano, mes-1, dia, hh, mm);
    }

    function formatBR(dt) {
      const p = n => String(n).padStart(2,'0');
      return `${p(dt.getDate())}/${p(dt.getMonth()+1)}/${p(dt.getFullYear())}, ${p(dt.getHours())}:${p(dt.getMinutes())}`;
    }

    function toLocalISO(dt) {
      const p = n => String(n).padStart(2,'0');
      return `${dt.getFullYear()}-${p(dt.getMonth()+1)}-${p(dt.getDate())}T${p(dt.getHours())}:${p(dt.getMinutes())}`;
    }

    function updateCounts() {
      let pend=0, conf=0, canc=0;
      agendamentos.forEach(a=>{
        if (a.status==='Confirmado') conf++;
        else if (a.status==='Cancelado') canc++;
        else pend++;
      });
      statusCounts.textContent = `Pendentes: ${pend} | Confirmados: ${conf} | Cancelados: ${canc}`;
    }

    function render() {
      tbody.innerHTML = '';
      agendamentos.forEach(a => {
        const sc = a.status==='Confirmado'
          ? 'status-confirmado'
          : a.status==='Cancelado'
            ? 'status-cancelado'
            : 'status-pendente';

        let displayDate = '';
        if (a.dataExame) {
          const [y,m,d] = a.dataExame.split('-');
          displayDate = `${d}/${m}/${y}`;
        }
        const dtText = `${displayDate} ${a.horaExame}`.trim();

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td data-label="Cl√≠nica">${a.clinica||''}</td>
          <td data-label="Nome">${a.nome}</td>
          <td data-label="CPF">${a.cpf}</td>
          <td data-label="Telefone">${a.telefone}</td>
          <td data-label="E-mail">${a.email}</td>
          <td data-label="Exame">${a.tipo}</td>
          <td data-label="Data/Hora Exame">${dtText}</td>
          <td data-label="Local">${a.localExame}</td>
          <td data-label="Status" class="status-cell ${sc}">${a.status}</td>
          <td data-label="A√ß√µes">
            <button class="action-btn confirm-btn" onclick="confirmar('${a.key}')">‚úîÔ∏è</button>
            <button class="action-btn cancel-btn-action" onclick="cancelar('${a.key}')">‚ùå</button>
            <button class="action-btn edit-btn" onclick="abrirModal('${a.key}')">‚úèÔ∏è</button>
            <button class="action-btn delete-btn" onclick="excluirAgendamento('${a.key}')">üóëÔ∏è</button>
          </td>`;
        tbody.appendChild(tr);
      });
      updateCounts();
    }

    refAgend.on('value', snap => {
      agendamentos = [];
      snap.forEach(child => {
        const v = child.val();
        agendamentos.push({
          key: child.key,
          clinica: v.clinica||'',
          nome: v.nome,
          cpf: v.cpf,
          telefone: v.telefone,
          email: v.email,
          tipo: v.tipo,
          dataExame: v.dataExame||'',
          horaExame: v.horaExame||'',
          localExame: v.localExame||'',
          status: v.status||'Pendente'
        });
      });
      render();
    });

    filtroTipo.addEventListener('input', render);
    filtroData.addEventListener('change', render);

    function abrirModal(key) {
      chaveAtual = key;
      const ag = agendamentos.find(a=>a.key===key);
      editClinica.value       = ag.clinica;
      document.getElementById('editNome').value      = ag.nome;
      document.getElementById('editCpf').value       = ag.cpf;
      document.getElementById('editTelefone').value  = ag.telefone;
      document.getElementById('editEmail').value     = ag.email;
      document.getElementById('editTipo').value      = ag.tipo;
      editDataInp.value       = ag.dataExame;
      document.getElementById('editHoraExame').value = ag.horaExame;
      document.getElementById('editLocalExame').value= ag.localExame;
      document.getElementById('editDataCriacao').value = toLocalISO(new Date());
      document.getElementById('modalEdit').style.display = 'flex';
    }

    function salvarEdicao() {
      if (!chaveAtual) return;
      const dt = new Date(document.getElementById('editDataCriacao').value);
      const up = {
        clinica: editClinica.value.trim(),
        nome: document.getElementById('editNome').value.trim(),
        cpf: document.getElementById('editCpf').value.trim(),
        telefone: document.getElementById('editTelefone').value.trim(),
        email: document.getElementById('editEmail').value.trim(),
        tipo: document.getElementById('editTipo').value,
        dataExame: editDataInp.value,
        horaExame: document.getElementById('editHoraExame').value,
        localExame: document.getElementById('editLocalExame').value.trim(),
        criadoEmTimestamp: dt.getTime(),
        criadoEmFormatado: formatBR(dt)
      };
      refAgend.child(chaveAtual).update(up).then(fecharModal);
    }

    function confirmar(key) {
      refAgend.child(key).update({ status:'Confirmado' }).then(()=>{
        const ag = agendamentos.find(a=>a.key===key);
        let displayDate='';
        if(ag.dataExame){
          const [y,m,d]=ag.dataExame.split('-');
          displayDate=`${d}/${m}/${y}`;
        }
        const displayDateTime = `${displayDate} ${ag.horaExame}`.trim();
        const msg =
          `ü©∫ *Confirma√ß√£o de Exame* ü©∫\n\n` +
         
          `üë§ *Nome:* ${ag.nome}\n` +
          `üÜî *CPF:* ${ag.cpf}\n` +
          `‚úâÔ∏è *E-mail:* ${ag.email}\n` +
          `üì± *Telefone:* ${ag.telefone}\n\n` +
           `üè• *Cl√≠nica:* ${ag.clinica}\n` +
          `‚úÖ *Exame:* ${ag.tipo}\n` +
          `üóìÔ∏è *Data/Hora:* ${displayDateTime}\n` +
          `üìç *Local:* ${ag.localExame}\n\n` +
          `At√© breve!`;
        const tel = ag.telefone.replace(/\D/g,'');
        window.open(
          `https://api.whatsapp.com/send?phone=55${tel}&text=${encodeURIComponent(msg)}`,
          '_blank'
        );
      });
    }

    function cancelar(key) { refAgend.child(key).update({ status:'Cancelado' }); }
    function excluirAgendamento(key) { if(confirm('Deseja realmente excluir este agendamento?')) refAgend.child(key).remove(); }
    function fecharModal() { document.getElementById('modalEdit').style.display='none'; chaveAtual=null; }

    firebase.auth().onAuthStateChanged(u=>{ if(!u) location.href='login.html'; });
  </script>
</body>
</html>
