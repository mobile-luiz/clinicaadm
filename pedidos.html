<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>📋 Agendamentos Realizados</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /*──────────────────────────────────────────────
      Variáveis CSS
    ──────────────────────────────────────────────*/
  /*──────────────────────────────────────────────
  Variáveis CSS
─:root {
  --primary:   #0066cc;
  --secondary: #f0f0f0;
  --bg:        #f4f4f4;
  --text:      #333;
  --confirm:   #27ae60;
  --cancel:    #c0392b;
  --pending:   #e67e22;
}

/* Reset e base */
:root {
  --primary: #0066cc;
  --secondary: #f8f9fa;
  --bg: #f4f6fb;
  --text: #333;
  --confirm: #27ae60;
  --cancel: #c0392b;
  --pending: #e67e22;
  --border: #dee2e6;
  --shadow: rgba(0, 0, 0, 0.05);
}

/* Reset e base */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}
body {
  font-family: 'Segoe UI', Tahoma, sans-serif;
  background: var(--bg);
  color: var(--text);
  padding: 20px;
}

/* Container principal */
.container {
  max-width: 1400px;
  margin: 0 auto;
  background: #fff;
  padding: 30px;
  border-radius: 16px;
  box-shadow: 0 4px 18px var(--shadow);
}

/* Título */
h2 {
  text-align: center;
  font-size: 2rem;
  color: var(--primary);
  margin-bottom: 20px;
}

/* Contador de status */
#statusCounts {
  text-align: center;
  margin-bottom: 20px;
  font-weight: bold;
  font-size: 1.1rem;
}

/* Filtros */
.filter-container {
  display: flex;
  justify-content: center;
  gap: 10px;
  flex-wrap: wrap;
  margin-bottom: 20px;
}
.filter-container input {
  width: 260px;
  padding: 10px 14px;
  border: 1px solid var(--border);
  border-radius: 10px;
  font-size: 1rem;
  transition: border 0.2s;
}
.filter-container input:focus {
  border-color: var(--primary);
  outline: none;
}

/* Tabela */
.table-wrapper {
  overflow-x: auto;
  overflow-y: auto;
  max-height: 500px;
  border-radius: 8px;
  border: 1px solid var(--border);
}
table {
  width: 100%;
  border-collapse: collapse;
  min-width: 1000px;
}
th, td {
  padding: 14px 18px;
  border: 1px solid var(--border);
  font-size: 0.95rem;
  text-align: center;
}
th {
  background: var(--secondary);
  position: sticky;
  top: 0;
  z-index: 1;
  font-weight: 600;
  text-transform: uppercase;
}
tr:nth-child(even) {
  background: #f9fafb;
}
tr:hover {
  background: #eef2f7;
}

/* Status */
.status-cell { font-weight: bold; }
.status-pendente   { color: var(--pending); }
.status-confirmado { color: var(--confirm); }
.status-cancelado  { color: var(--cancel); }

/* Botões */
.action-btn {
  padding: 8px 10px;
  font-size: 0.85rem;
  border: none;
  border-radius: 6px;
  color: #fff;
  cursor: pointer;
  margin: 2px;
  transition: all 0.2s ease-in-out;
}
.confirm-btn       { background: var(--confirm); }
.confirm-btn:hover { background: #1e874d; }
.cancel-btn-action { background: var(--cancel); }
.cancel-btn-action:hover { background: #a93226; }
.edit-btn          { background: #f39c12; }
.edit-btn:hover    { background: #d68910; }
.delete-btn        { background: #dc3545; }
.delete-btn:hover  { background: #c82333; }

/* Modal */
#modalEdit {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.6);
  align-items: center;
  justify-content: center;
  padding: 10px;
  z-index: 999;
}
.modal-content {
  background: #fff;
  padding: 24px;
  border-radius: 12px;
  max-width: 420px;
  width: 100%;
  box-shadow: 0 4px 12px var(--shadow);
}
.modal-content h3 {
  margin-bottom: 16px;
  color: var(--primary);
}
.modal-content label {
  display: block;
  margin-top: 10px;
  font-weight: 600;
}
.modal-content input,
.modal-content select {
  width: 100%;
  padding: 10px;
  margin-top: 4px;
  border: 1px solid #ccc;
  border-radius: 8px;
  font-size: 1rem;
}
.modal-actions {
  margin-top: 20px;
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}
.modal-actions button {
  padding: 10px 16px;
  border: none;
  border-radius: 6px;
  font-size: 0.95rem;
  cursor: pointer;
}
.save-btn        { background: var(--confirm); color: #fff; }
.save-btn:hover  { background: #1e874d; }
.cancel-btn      { background: #bdc3c7; color: #2c3e50; }
.cancel-btn:hover{ background: #a4acb0; }

/* Responsivo */
@media (max-width: 768px) {
  .filter-container {
    flex-direction: column;
    align-items: center;
  }
  .filter-container input {
    width: 100%;
    max-width: 100%;
  }
  thead {
    display: none;
  }
  table {
    min-width: unset;
  }
  tr {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 15px;
    background: #fff;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 10px;
  }
  td {
    display: flex;
    justify-content: space-between;
    border: none;
    padding: 8px;
    border-bottom: 1px solid var(--border);
    text-align: left;
  }
  td::before {
    content: attr(data-label) ": ";
    font-weight: 600;
    margin-right: 6px;
  }
  td:last-child {
    grid-column: 1 / -1;
    justify-content: flex-start;
  }
  #paginacao button:hover {
  background: #0056b3;
  color: #fff;
}

}

  </style>
</head>
<body>
  <div class="container">
    <h2>📋 Agendamentos Realizados</h2>
    <div id="statusCounts">Carregando contagens...</div>
    <div class="filter-container">
      <input id="filterTipo" type="text" placeholder="🔍 Exame ou CPF…">
      <input id="filterData" type="date">
    <div style="text-align:right; margin-bottom: 10px;">
  <button onclick="exportarExcel()" style="padding: 10px 16px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer;">
    ⬇️ Exportar para Excel
  </button>
</div>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Clínica</th>
            <th>Nome</th>
            <th>CPF</th>
            <th>Telefone</th>
            <th>E-mail</th>
            <th>Exame</th>
            <th>Data/Hora Exame</th>
            <th>Local</th>
            <th>Status</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="listaAgendamentos">
          <tr><td colspan="10" style="padding:20px">Carregando agendamentos...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div id="modalEdit">
    <div class="modal-content">
      <h3>✏️ Editar Agendamento</h3>
      <label>Clínica</label><input id="editClinica" type="text" placeholder="Digite o nome da clínica">
      <label>Nome</label><input id="editNome" type="text">
      <label>CPF</label><input id="editCpf" type="text">
      <label>Telefone</label><input id="editTelefone" type="text">
      <label>E-mail</label><input id="editEmail" type="email">
      <label>Tipo de Exame</label>
      <select id="editTipo">
        <option>Hemograma Completo</option>
        <option>Urina Tipo I</option>
        <option>Raio-X Simples</option>
        <option>Ultrassonografia</option>
        <option>Tomografia Computadorizada</option>
        <option>Ressonância Magnética</option>
        <option>Eletrocardiograma (ECG)</option>
        <option>Ecocardiograma</option>
        <option>Endoscopia Digestiva</option>
        <option>Colonoscopia</option>
        <option>Mamografia</option>
        <option>Densitometria Óssea</option>
        <option>Biópsia</option>
        <option>Glicemia de Jejum</option>
        <option>Teste de Esforço</option>
        <option>Perfil Lipídico</option>
        <option>Outros</option>
      </select>
      <label>Data do Exame</label><input id="editDataExame" type="date">
      <label>Hora do Exame</label><input id="editHoraExame" type="time">
      <label>Local do Exame</label><input id="editLocalExame" type="text" placeholder="Digite o local">
      <label>Data de Criação</label><input id="editDataCriacao" type="datetime-local">
      <div class="modal-actions">
        <button class="save-btn" onclick="salvarEdicao()">Salvar</button>
        <button class="cancel-btn" onclick="fecharModal()">Cancelar</button>
      </div>
    </div>
  </div>
<div id="paginacao" style="text-align:center; margin-top: 20px;"></div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
  firebase.initializeApp({
  databaseURL: "https://clinica-3f715-default-rtdb.firebaseio.com/"
});

let paginaAtual = 1;
const itensPorPagina = 50;


   // firebase.initializeApp(firebaseConfig);

    const refAgend     = firebase.database().ref('agendamentos');
    const filtroTipo   = document.getElementById('filterTipo');
    const filtroData   = document.getElementById('filterData');
    const tbody        = document.getElementById('listaAgendamentos');
    const statusCounts = document.getElementById('statusCounts');
    const editClinica  = document.getElementById('editClinica');
    const editDataInp  = document.getElementById('editDataExame');
    let agendamentos = [], chaveAtual = null;

    // Bloqueia datas anteriores a hoje
    editDataInp.min = new Date().toISOString().split('T')[0];

    function parseBR(str) {
      if (!str) return new Date(0);
      const [d,t] = str.split(', '),
            [dia,mes,ano] = d.split('/').map(Number),
            [hh,mm] = t.split(':').map(Number);
      return new Date(ano, mes-1, dia, hh, mm);
    }

    function formatBR(dt) {
      const p = n => String(n).padStart(2,'0');
      return `${p(dt.getDate())}/${p(dt.getMonth()+1)}/${p(dt.getFullYear())}, ${p(dt.getHours())}:${p(dt.getMinutes())}`;
    }

    function toLocalISO(dt) {
      const p = n => String(n).padStart(2,'0');
      return `${dt.getFullYear()}-${p(dt.getMonth()+1)}-${p(dt.getDate())}T${p(dt.getHours())}:${p(dt.getMinutes())}`;
    }

    function updateCounts() {
      let pend=0, conf=0, canc=0;
      agendamentos.forEach(a=>{
        if (a.status==='Confirmado') conf++;
        else if (a.status==='Cancelado') canc++;
        else pend++;
      });
      statusCounts.textContent = `Pendentes: ${pend} | Confirmados: ${conf} | Cancelados: ${canc}`;
    }

 function render() {
  tbody.innerHTML = '';

  const termo = filtroTipo.value.toLowerCase().trim();
  const termoData = filtroData.value;

  const agFiltrados = agendamentos.filter(a => {
    const nomeOk  = a.nome && a.nome.toLowerCase().includes(termo);
    const exameOk = a.tipo && a.tipo.toLowerCase().includes(termo);
    const cpfOk   = a.cpf && a.cpf.replace(/\D/g, '').includes(termo.replace(/\D/g, ''));
    const buscaOk = !termo || nomeOk || exameOk || cpfOk;
    const dataOk  = !termoData || (a.dataExame && a.dataExame === termoData);
    return buscaOk && dataOk;
  });

  const totalPaginas = Math.ceil(agFiltrados.length / itensPorPagina);
  if (paginaAtual > totalPaginas) paginaAtual = totalPaginas || 1;

  const inicio = (paginaAtual - 1) * itensPorPagina;
  const fim = inicio + itensPorPagina;
  const pagina = agFiltrados.slice(inicio, fim);

  pagina.forEach(a => {
    const sc = a.status === 'Confirmado'
      ? 'status-confirmado'
      : a.status === 'Cancelado'
        ? 'status-cancelado'
        : 'status-pendente';

    let displayDate = '';
    if (a.dataExame) {
      const [y, m, d] = a.dataExame.split('-');
      displayDate = `${d}/${m}/${y}`;
    }
    const dtText = `${displayDate} ${a.horaExame}`.trim();

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td data-label="Clínica">${a.clinica || ''}</td>
      <td data-label="Nome">${a.nome}</td>
      <td data-label="CPF">${a.cpf}</td>
      <td data-label="Telefone">${a.telefone}</td>
      <td data-label="E-mail">${a.email}</td>
      <td data-label="Exame">${a.tipo}</td>
      <td data-label="Data/Hora Exame">${dtText}</td>
      <td data-label="Local">${a.localExame}</td>
      <td data-label="Status" class="status-cell ${sc}">${a.status}</td>
      <td data-label="Ações">
        <button class="action-btn confirm-btn" onclick="confirmar('${a.key}')">✔️</button>
        <button class="action-btn cancel-btn-action" onclick="cancelar('${a.key}')">❌</button>
        <button class="action-btn edit-btn" onclick="abrirModal('${a.key}')">✏️</button>
        <button class="action-btn delete-btn" onclick="excluirAgendamento('${a.key}')">🗑️</button>
      </td>`;
    tbody.appendChild(tr);
  });

  updateCounts();
  renderPaginacao(totalPaginas);
}

function exportarExcel() {
  const dados = agendamentos.map(a => ({
    'Clínica': a.clinica || '',
    'Nome': a.nome || '',
    'CPF': a.cpf || '',
    'Telefone': a.telefone || '',
    'E-mail': a.email || '',
    'Exame': a.tipo || '',
    'Data Exame': a.dataExame || '',
    'Hora Exame': a.horaExame || '',
    'Local': a.localExame || '',
    'Status': a.status || ''
  }));

  const ws = XLSX.utils.json_to_sheet(dados);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Agendamentos");

  XLSX.writeFile(wb, "agendamentos.xlsx");
}



function renderPaginacao(totalPaginas) {
  const container = document.getElementById('paginacao');
  container.innerHTML = '';

  if (totalPaginas <= 1) return;

  for (let i = 1; i <= totalPaginas; i++) {
    const btn = document.createElement('button');
    btn.textContent = i;
    btn.style.margin = '0 4px';
    btn.style.padding = '6px 12px';
    btn.style.borderRadius = '6px';
    btn.style.border = '1px solid #ccc';
    btn.style.cursor = 'pointer';
    btn.style.background = i === paginaAtual ? '#0066cc' : '#fff';
    btn.style.color = i === paginaAtual ? '#fff' : '#333';
    btn.onclick = () => {
      paginaAtual = i;
      render();
    };
    container.appendChild(btn);
  }
}




    refAgend.on('value', snap => {
      agendamentos = [];
      snap.forEach(child => {
        const v = child.val();
        agendamentos.push({
          key: child.key,
          clinica: v.clinica||'',
          nome: v.nome,
          cpf: v.cpf,
          telefone: v.telefone,
          email: v.email,
          tipo: v.tipo,
          dataExame: v.dataExame||'',
          horaExame: v.horaExame||'',
          localExame: v.localExame||'',
          status: v.status||'Pendente'
        });
      });
      render();
    });

    filtroTipo.addEventListener('input', render);
    filtroData.addEventListener('change', render);

    function abrirModal(key) {
      chaveAtual = key;
      const ag = agendamentos.find(a=>a.key===key);
      editClinica.value       = ag.clinica;
      document.getElementById('editNome').value      = ag.nome;
      document.getElementById('editCpf').value       = ag.cpf;
      document.getElementById('editTelefone').value  = ag.telefone;
      document.getElementById('editEmail').value     = ag.email;
      document.getElementById('editTipo').value      = ag.tipo;
      editDataInp.value       = ag.dataExame;
      document.getElementById('editHoraExame').value = ag.horaExame;
      document.getElementById('editLocalExame').value= ag.localExame;
      document.getElementById('editDataCriacao').value = toLocalISO(new Date());
      document.getElementById('modalEdit').style.display = 'flex';
    }

    function salvarEdicao() {
      if (!chaveAtual) return;
      const dt = new Date(document.getElementById('editDataCriacao').value);
      const up = {
        clinica: editClinica.value.trim(),
        nome: document.getElementById('editNome').value.trim(),
        cpf: document.getElementById('editCpf').value.trim(),
        telefone: document.getElementById('editTelefone').value.trim(),
        email: document.getElementById('editEmail').value.trim(),
        tipo: document.getElementById('editTipo').value,
        dataExame: editDataInp.value,
        horaExame: document.getElementById('editHoraExame').value,
        localExame: document.getElementById('editLocalExame').value.trim(),
        criadoEmTimestamp: dt.getTime(),
        criadoEmFormatado: formatBR(dt)
      };
      refAgend.child(chaveAtual).update(up).then(fecharModal);
    }

    function confirmar(key) {
      refAgend.child(key).update({ status:'Confirmado' }).then(()=>{
        const ag = agendamentos.find(a=>a.key===key);
        let displayDate='';
        if(ag.dataExame){
          const [y,m,d]=ag.dataExame.split('-');
          displayDate=`${d}/${m}/${y}`;
        }
        const displayDateTime = `${displayDate} ${ag.horaExame}`.trim();
        const msg =
          `🩺 *Confirmação de Exame* 🩺\n\n` +
         
          `👤 *Nome:* ${ag.nome}\n` +
          `🆔 *CPF:* ${ag.cpf}\n` +
          `✉️ *E-mail:* ${ag.email}\n` +
          `📱 *Telefone:* ${ag.telefone}\n\n` +
           `🏥 *Clínica:* ${ag.clinica}\n` +
          `✅ *Exame:* ${ag.tipo}\n` +
          `🗓️ *Data/Hora:* ${displayDateTime}\n` +
          `📍 *Local:* ${ag.localExame}\n\n` +
          `Até breve!`;
        const tel = ag.telefone.replace(/\D/g,'');
        window.open(
          `https://api.whatsapp.com/send?phone=55${tel}&text=${encodeURIComponent(msg)}`,
          '_blank'
        );
      });
    }

    function cancelar(key) { refAgend.child(key).update({ status:'Cancelado' }); }
    function excluirAgendamento(key) { if(confirm('Deseja realmente excluir este agendamento?')) refAgend.child(key).remove(); }
    function fecharModal() { document.getElementById('modalEdit').style.display='none'; chaveAtual=null; }

    firebase.auth().onAuthStateChanged(u=>{ if(!u) location.href='login.html'; });
  </script>
</body>
</html>
